define(["angular","lodash","cjt/util/locale","cjt/validator/email-validator","cjt/directives/validationItemDirective","cjt/directives/validationContainerDirective","cjt/directives/validateEqualsDirective","cjt/directives/passwordFieldDirective","cjt/directives/actionButtonDirective","app/directives/validateUsernameWithDomain","app/directives/emailServiceConfig","app/directives/ftpServiceConfig","app/directives/webdiskServiceConfig","uiBootstrap"],function(angular,_,LOCALE){var DEFAULT_PASSWORD_STRENGTH=10;var app=angular.module("App");var factory=function($scope,userService,emailDaemonInfo,ftpDaemonInfo,webdiskDaemonInfo,features,defaultInfo,quotaInfo,alertService){var controller={initializeScope:function(){$scope.ui={docrootByDomain:PAGE.docrootByDomain,domainList:Object.keys(PAGE.docrootByDomain),user:userService.emptyUser()};$scope.isOverQuota=!quotaInfo.under_quota_overall;$scope.ui.user.domain=PAGE.primaryDomain;$scope.ui.user.services.ftp.homedir=PAGE.docrootByDomain[PAGE.primaryDomain]+"/";$scope.ui.user.services.webdisk.homedir=PAGE.docrootByDomain[PAGE.primaryDomain]+"/";$scope.inProgress=false;$scope.minimumPasswordStrength=angular.isDefined(PAGE.minimumPasswordStrength)?parseInt(PAGE.minimumPasswordStrength,10):DEFAULT_PASSWORD_STRENGTH;$scope.emailDaemon=emailDaemonInfo;$scope.ftpDaemon=ftpDaemonInfo;$scope.webdiskDaemon=webdiskDaemonInfo;$scope.features=features;$scope.defaults=defaultInfo;$scope.quotaInfo=quotaInfo;$scope.useCandidateServices=this.useCandidateServices;$scope.insertSubAndRemoveDupes=this.insertSubAndRemoveDupes},initializeView:function(){alertService.clear();this.showCpanelOverQuotaWarning()},clearPrefetch:function(){app.firstLoad.userList=false},useCandidateServices:function(destUser,srcUser){userService.integrateCandidateServices(destUser,srcUser)},insertSubAndRemoveDupes:function(newUser,userList){var startingIndex=_.sortedIndexBy(userList,newUser,"full_username");var enabledServices=[];angular.forEach(newUser.services,function(service,serviceName){if(service.enabled){enabledServices.push(serviceName)}});if(newUser.dismissed_merge_candidates){newUser.dismissed_merge_candidates.forEach(function(serviceAccount){enabledServices.push(serviceAccount.service)})}var index=startingIndex;var splice,user,serviceName;while(userList[index]&&userList[index].full_username===newUser.full_username){user=userList[index];if(user.type!=="service"){splice=true}else{for(var esi=0,esl=enabledServices.length;esi<esl;esi++){serviceName=enabledServices[esi];if(user.services[serviceName].enabled){splice=true;break}}}if(splice){userList.splice(index,1)}else{index++}}var usersToInsert=userService.expandDismissed(newUser);userList.splice.apply(userList,[startingIndex,0].concat(usersToInsert))},showCpanelOverQuotaWarning:function(){if($scope.isOverQuota){alertService.add({message:LOCALE.maketext("Your [asis,cPanel] account exceeds its disk quota. You cannot add or edit users."),type:"danger",id:"over-quota-warning",replace:false,counter:false})}}};return controller};return factory});