define(["lodash","angular","cjt/util/locale","uiBootstrap","cjt/directives/actionButtonDirective","cjt/directives/loadingPanel","cjt/directives/toggleSortDirective","cjt/directives/searchDirective","cjt/directives/pageSizeDirective","cjt/filters/startFromFilter","cjt/decorators/paginationDecorator","cjt/services/ComponentSettingSaverService"],function(_,angular,LOCALE){var app;try{app=angular.module("cpanel.mail.Pops")}catch(e){app=angular.module("cpanel.mail.Pops",[])}app.controller("listEmailAccountsCtrl",["$rootScope","$scope","$timeout","emailAccountsService","growl","$window","ComponentSettingSaverService",function($rootScope,$scope,$timeout,emailAccountsService,growl,$window,ComponentSettingSaverService){var COMPONENT_NAME="EmailAccountsTable";$scope.emailAccounts=[];$scope.filteredList=[];$scope.requiredPasswordStrength=PAGE.requiredPasswordStrength;$scope.webmailEnabled=PAGE.webmailEnabled;$scope.externalAuthConfig=PAGE.externalAuthModulesConfigured;$scope.showCalAndContacts=PAGE.showCalendarAndContactItems;$scope.emailDiskUsageEnabled=PAGE.emailDiskUsageEnabled;$scope.defaultQuota=PAGE.userDefinedQuotaDefaultValue;$scope.maxQuota=PAGE.maxEmailQuota;$scope.expandedAccount=undefined;$scope.loadingEmailAccounts=false;$scope.actionModule=undefined;$scope.passwordChange={password:undefined,confirm:undefined};$scope.changingPassword=false;$scope.quotaChange={quotaType:undefined,quota:undefined};$scope.changingQuota=false;$scope.meta={sortReverse:false,sortBy:"user",sortDirection:"asc",sortFields:["user","domain","_diskused","_diskquota","diskusedpercent"],filterValue:"",maxPages:5,totalItems:$scope.emailAccounts.length,currentPage:1,pageSize:20,pageSizes:[20,50,100,500],start:0,limit:10};$scope.setMetaFromComponentSettings=function(settings){if(settings.hasOwnProperty("sortBy")&&settings.sortBy&&_.find($scope.meta.sortFields,function(f){return f===settings.sortBy})){$scope.meta.sortBy=settings.sortBy}if(settings.hasOwnProperty("sortDirection")&&settings.sortDirection&&(settings.sortDirection==="asc"||settings.sortDirection==="desc")){$scope.meta.sortDirection=settings.sortDirection}if(settings.hasOwnProperty("pageSize")&&settings.pageSize&&_.find($scope.meta.pageSizes,function(s){return s===parseInt(settings.pageSize)})){$scope.meta.pageSize=parseInt(settings.pageSize)}if(settings.hasOwnProperty("filterValue")){$scope.meta.filterValue=settings.filterValue}};$scope.saveMetaToComponentSettings=function(){ComponentSettingSaverService.set(COMPONENT_NAME,{sortBy:$scope.meta.sortBy,sortDirection:$scope.meta.sortDirection,pageSize:$scope.meta.pageSize,filterValue:$scope.meta.filterValue})};$scope.clearStatus=function(){$scope.expandedAccount.status=undefined};$scope.onMenuToggle=function(index){var dropdownContainer=angular.element("#email_table_menu_"+index);if(!dropdownContainer||dropdownContainer.length!==1){return}dropdownContainer=dropdownContainer[0];var position=dropdownContainer.getBoundingClientRect().top;var buttonHeight=dropdownContainer.getBoundingClientRect().height;var dropdownMenu=angular.element("#email_table_menu_"+index+" .dropdown-menu");if(!dropdownMenu||dropdownMenu.length!==1){return}dropdownMenu=dropdownMenu[0];var menuHeight=parseInt($window.getComputedStyle(dropdownMenu).height);$scope.isDropUp=position>menuHeight&&$window.innerHeight-position<buttonHeight+menuHeight};$scope.cancelAction=function(){$scope.expandedAccount=undefined;$scope.actionModule=undefined};$scope.onClickPassword=function(emailAccount){$scope.passwordChange={};if($scope.expandedAccount===emailAccount&&$scope.actionModule==="password"){$scope.actionModule=undefined}else{if($scope.expandedAccount){$scope.expandedAccount.status=undefined}$scope.actionModule="password";$scope.expandedAccount=emailAccount}};$scope.onClickChangePassword=function(){$scope.changingPassword=true;$scope.expandedAccount.status=undefined;return emailAccountsService.changePassword($scope.expandedAccount.user,$scope.expandedAccount.domain,$scope.passwordChange.password).then(function(){$scope.expandedAccount.status={message:LOCALE.maketext("Password for “[_1]” has been changed.",$scope.expandedAccount.user+"@"+$scope.expandedAccount.domain),type:"success",closeable:true,ttl:1e4};$scope.changingPassword=false;$scope.passwordChange={};$scope.actionModule=undefined},function(error){if($scope.expandedAccount){$scope.expandedAccount.status=undefined}$scope.expandedAccount.status={type:"danger",message:error};$scope.changingPassword=false})};$scope.onClickQuota=function(emailAccount){if($scope.expandedAccount===emailAccount&&$scope.actionModule==="quota"){$scope.actionModule=undefined}else{if($scope.expandedAccount){$scope.expandedAccount.status=undefined}$scope.actionModule="quota";$scope.expandedAccount=emailAccount;if(!emailAccount._diskquota||emailAccount._diskquota===0){$scope.quotaChange.quotaType="unlimited";$scope.quotaChange.quota=$scope.defaultQuota}else{$scope.quotaChange.quotaType="userdefined";$scope.quotaChange.quota=emailAccount.diskquota}}};$scope.onClickChangeQuota=function(){$scope.changingQuota=true;$scope.expandedAccount.status=undefined;var emailAccount=$scope.expandedAccount;var quotaValue=$scope.quotaChange.quotaType==="unlimited"?0:$scope.quotaChange.quota;return emailAccountsService.changeQuota(emailAccount.user,emailAccount.domain,quotaValue).then(function(){$scope.changingQuota=false;var statusText;if($scope.quotaChange.quotaType==="unlimited"){statusText=LOCALE.maketext("Changed Quota for “[_1]” to unlimited.",emailAccount.user+"@"+emailAccount.domain)}else{statusText=LOCALE.maketext("Changed Quota for “[_1]” to [numf,_2] MB.",emailAccount.user+"@"+emailAccount.domain,quotaValue)}$scope.expandedAccount.status={type:"success",message:statusText,closeable:true,ttl:1e4};if($scope.quotaChange.quotaType==="unlimited"||quotaValue===0){emailAccount._diskquota=0;emailAccount.diskquota="unlimited";emailAccount.humandiskquota="&infin;";emailAccount.diskusedpercent=0}else{emailAccount._diskquota=quotaValue;emailAccount.diskquota=quotaValue;emailAccount.humandiskquota=quotaValue;emailAccount.diskusedpercent=(emailAccount.diskused/emailAccount.diskquota*100).toFixed(2)}emailAccount.humandiskusedpercent=LOCALE.maketext("[_1]%",emailAccount.diskusedpercent);$scope.actionModule=undefined},function(error){$scope.changingQuota=false;$scope.expandedAccount.status={type:"danger",message:error}})};$scope.onClickDelete=function(emailAccount){if($scope.expandedAccount===emailAccount&&$scope.actionModule==="delete"){$scope.actionModule=undefined}else{if($scope.expandedAccount){$scope.expandedAccount.status=undefined}$scope.actionModule="delete";$scope.expandedAccount=emailAccount}};$scope.onClickDeleteConfirm=function(){$scope.deletingAccount=true;$scope.expandedAccount.status=undefined;$scope.expandedAccount.deleting=true;return emailAccountsService.deleteEmailAccount($scope.expandedAccount.user,$scope.expandedAccount.domain).then(function(){$scope.expandedAccount.deleted=true;$scope.expandedAccount.status={message:LOCALE.maketext("Account “[_1]” deleted.",$scope.expandedAccount.user+"@"+$scope.expandedAccount.domain),type:"success",closeable:true,ttl:1e4};$scope.deletingAccount=false;$scope.actionModule=undefined},function(error){$scope.expandedAccount.status={type:"danger",message:error};$scope.deletingAccount=false})};$scope.sortList=function(){if($scope.currentFetchTimeout){$timeout.cancel($scope.currentFetchTimeout)}$scope.currentFetchTimeout=$timeout(function(){$scope.saveMetaToComponentSettings();$scope.meta.currentPage=1;$scope.fetch()},250)};$scope.selectPage=function(){if($scope.currentFetchTimeout){$timeout.cancel($scope.currentFetchTimeout)}$scope.currentFetchTimeout=$timeout(function(){$scope.fetch()},250)};$scope.selectPageSize=function(){if($scope.currentFetchTimeout){$timeout.cancel($scope.currentFetchTimeout)}$scope.currentFetchTimeout=$timeout(function(){$scope.saveMetaToComponentSettings();$scope.meta.currentPage=1;$scope.fetch()},250)};$scope.searchList=function(){$scope.filterTermPending=true;if($scope.currentFetchTimeout){$timeout.cancel($scope.currentFetchTimeout)}$scope.currentFetchTimeout=$timeout(function(){$scope.saveMetaToComponentSettings();$scope.meta.currentPage=1;$scope.fetch()},250)};$scope.collapseFinished=function(){if($scope.actionModule===undefined){$scope.expandedAccount=undefined}};$scope.fetch=function(){$scope.loadingEmailAccounts=true;$scope.meta.mobileItemCountText=undefined;var sortMethod="lexicographic";if($scope.meta.sortBy==="_diskused"||$scope.meta.sortBy==="diskusedpercent"){sortMethod="numeric"}else if($scope.meta.sortBy==="_diskquota"){sortMethod="numeric_zero_as_max"}var apiParams={"api.sort":1,"api.sort_column":$scope.meta.sortBy,"api.sort_method":sortMethod,"api.sort_reverse":$scope.meta.sortDirection==="asc"?0:1,"api.paginate":1,"api.paginate_start":($scope.meta.currentPage-1)*$scope.meta.pageSize,"api.paginate_size":$scope.meta.pageSize,"api.paginate_page":$scope.meta.currentPage};if($scope.meta.filterValue&&$scope.meta.filterValue!==""){apiParams["api.filter"]=1;apiParams["api.filter_term_0"]=$scope.meta.filterValue;apiParams["api.filter_column_0"]="login"}$scope.filteredList=[];var container=angular.element("#popsAccountList");if(container&&container[0]){container.css({minHeight:$window.getComputedStyle(container[0]).height})}var apiPromise=emailAccountsService.getEmailAccounts(apiParams);$scope.fetchPromise=apiPromise;apiPromise.then(function(response){if($scope.fetchPromise!==apiPromise){return}var data=response.data;var metadata=response.meta;$scope.meta.totalItems=metadata.paginate.total_records;if($scope.meta.totalItems>_.min($scope.meta.pageSizes)){$scope.showPager=true;var start=($scope.meta.currentPage-1)*$scope.meta.pageSize;$scope.meta.start=start+1;$scope.meta.limit=start+data.length}else{$scope.showPager=false;if(data.length===0){$scope.meta.start=0}else{$scope.meta.start=1}$scope.meta.limit=data.length}$scope.meta.mobileItemCountText=LOCALE.maketext("Displaying [_1] to [_2] out of [_3] records",$scope.meta.start,$scope.meta.limit,$scope.meta.totalItems);angular.element("#popsAccountList").css({minHeight:""});$scope.filteredList=data;$scope.loadingEmailAccounts=false;$scope.filterTermPending=false},function(error){growl.error(error);$scope.loadingEmailAccounts=false;$scope.filterTermPending=false})};$scope.getSearchClass=function(){if(!$scope.filterTermPending&&!$scope.loadingEmailAccounts&&$scope.meta.filterValue){return $scope.filteredList.length>0?"success":"danger"}else{return""}};var unregisterAddListener=$rootScope.$on("emailAccountAdded",$scope.fetch);if(PAGE.nvdata&&PAGE.nvdata.hasOwnProperty(COMPONENT_NAME)){$scope.setMetaFromComponentSettings(PAGE.nvdata[COMPONENT_NAME])}$scope.$on("$destroy",function(){ComponentSettingSaverService.unregister(COMPONENT_NAME);unregisterAddListener()});ComponentSettingSaverService.register(COMPONENT_NAME);$timeout($scope.fetch)}])});